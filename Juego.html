<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Caballo Saltar铆n (Runner)</title>
    <style>
        /* =================== ESTILOS CSS =================== */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom, #dff0ff, #b8e0f5);
            font-family: monospace;
            /* Previene la selecci贸n de texto al tocar */
            user-select: none; 
            /* Previene el zoom al tocar r谩pido */
            touch-action: manipulation; 
        }

        #juego-contenedor {
            width: 600px;
            height: 150px;
            border-bottom: 3px solid #333;
            overflow: hidden;
            position: relative;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }
        
        /* Media Query para mejor visualizaci贸n en pantallas peque帽as */
        @media (max-width: 650px) {
            #juego-contenedor {
                width: 90vw; 
                height: 120px;
            }
        }

        #caballo {
            width: 40px;
            height: 40px;
            /* Verifica que 'caballo.png' exista */
            background-image: url('caballo.png'); 
            background-size: cover;
            position: absolute;
            bottom: 0;
            left: 50px;
            z-index: 10;
        }

        .arbol {
            width: 20px;
            height: 40px;
            /* Verifica que 'arbol.png' exista */
            background-image: url('arbol.png'); 
            background-size: cover;
            position: absolute;
            bottom: 0;
        }

        #puntuacion {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 1.1em;
            color: #444;
            z-index: 20;
        }

        #mejorPuntuacion {
            position: absolute;
            top: 8px;
            left: 10px;
            font-size: 1.1em;
            color: #444;
            z-index: 20;
        }

        .oculto {
            display: none !important;
        }

        #mensaje-fin {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.4em;
            color: #333;
            text-align: center;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 2px solid #333;
            border-radius: 10px;
            z-index: 30;
        }

        #mensaje-fin button {
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            transition: 0.2s;
        }

        #mensaje-fin button:hover {
            background-color: #3e9142;
        }
        /* ================= END ESTILOS CSS ================= */
    </style>
</head>
<body>

    <div id="juego-contenedor">
        <div id="caballo"></div>
        <div id="puntuacion">Puntos: 0</div>
        <div id="mejorPuntuacion">Mejor: 0</div>

        <div id="mensaje-fin" class="oculto">
            GAME OVER<br>
            <span id="puntuacion-final"></span><br>
            <span id="mejor-final"></span><br>
            <button onclick="reiniciarJuego()">REINTENTAR</button>
        </div>
    </div>

    <audio id="sonido-salto" src="salto.mp3"></audio>
    <audio id="sonido-gameover" src="gameover.mp3"></audio>


<script>
    // ================== VARIABLES ==================
    const caballo = document.getElementById('caballo');
    const contenedor = document.getElementById('juego-contenedor');
    const mensajeFin = document.getElementById('mensaje-fin');
    const puntuacionDisplay = document.getElementById('puntuacion');
    const mejorDisplay = document.getElementById('mejorPuntuacion');
    const sonidoSalto = document.getElementById('sonido-salto');
    const sonidoGameOver = document.getElementById('sonido-gameover');

    let estaSaltando = false;
    let juegoActivo = true;
    let puntuacion = 0;
    
    //  VARIABLES DE PROGRESIN Y DIFICULTAD
    let velocidadArbol = 2.5;   
    const ACELERACION = 0.05;  
    const MAX_VELOCIDAD = 12;   
    
    //  AJUSTE CLAVE PARA SALTO MS FLUIDO
    let gravedad = 0.4; 
    const VELOCIDAD_SALTO_INICIAL = 10; 
    const TIEMPO_BASE_APARICION = 5500; 
    
    let intervaloPuntuacion;
    let timeoutGeneracionArboles; 
    let mejorPuntuacion = localStorage.getItem('mejorPuntuacion') || 0;
    mejorDisplay.textContent = 'Mejor: ' + mejorPuntuacion;

    // ================== SALTO ==================
    function saltar() {
        if (!estaSaltando && juegoActivo) {
            estaSaltando = true;
            sonidoSalto.currentTime = 0; 
            // Manejo de promesa para evitar errores de reproducci贸n en algunos m贸viles
            const playPromise = sonidoSalto.play(); 
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    // console.log("Fallo al reproducir sonido de salto: ", error);
                });
            }


            let velocidadVertical = VELOCIDAD_SALTO_INICIAL;
            let posicion = 0;

            const saltoAnimacion = () => {
                if (!juegoActivo) return;

                posicion += velocidadVertical;
                velocidadVertical -= gravedad; 

                if (posicion <= 0) {
                    posicion = 0;
                    estaSaltando = false;
                }

                caballo.style.bottom = posicion + 'px';
                if (estaSaltando || posicion > 0) {
                    requestAnimationFrame(saltoAnimacion);
                }
            };

            requestAnimationFrame(saltoAnimacion);
        }
    }
    
    // ================== CONTROL DE EVENTOS MEJORADO ==================

    // 锔 CONTROL DE TECLADO (Para escritorio)
    document.addEventListener('keydown', (event) => {
        if (event.code === 'Space' || event.code === 'ArrowUp') {
            event.preventDefault();
            saltar();
        }
    });

    //  CONTROL TCTIL (M贸viles) 
    // Usamos 'touchstart' que es m谩s r谩pido que 'click' en dispositivos m贸viles.
    contenedor.addEventListener('touchstart', (event) => {
        // Solo salta si el juego est谩 activo y NO se toc贸 el bot贸n de "REINTENTAR"
        if (juegoActivo && event.target.tagName !== 'BUTTON') { 
            event.preventDefault(); // Previene el zoom o scroll accidental
            saltar();
        }
    });
    
    // Fallback de click para algunos navegadores
    contenedor.addEventListener('click', (event) => {
        if (juegoActivo && event.target.tagName !== 'BUTTON') {
             saltar();
        }
    });


    // ================== LGICA DEL JUEGO (Sin Cambios Relevantes) ==================

    function generarArbol() {
        const arbol = document.createElement('div');
        arbol.classList.add('arbol');
        contenedor.appendChild(arbol);

        let posicionArbolLeft = contenedor.offsetWidth; 
        const arbolWidth = 20;
        const arbolHeight = 40;

        function moverArbol() {
            if (!juegoActivo) {
                arbol.remove();
                return;
            }

            posicionArbolLeft -= velocidadArbol; 
            arbol.style.left = posicionArbolLeft + 'px';

            const caballoPosBottom = parseInt(caballo.style.bottom) || 0;
            const caballoPosLeft = 50;
            const caballoWidth = 40;

            const colisionX =
                caballoPosLeft + caballoWidth > posicionArbolLeft &&
                caballoPosLeft < posicionArbolLeft + arbolWidth;
            const colisionY = caballoPosBottom < arbolHeight;

            if (colisionX && colisionY) {
                juegoActivo = false;
                finJuego();
                return;
            }

            if (posicionArbolLeft <= -arbolWidth) {
                arbol.remove();
                return;
            }

            requestAnimationFrame(moverArbol);
        }

        requestAnimationFrame(moverArbol);
    }

    function iniciarGeneracionArboles() {
        const tiempoBase = TIEMPO_BASE_APARICION / velocidadArbol; 
        const tiempoEspera = tiempoBase + Math.random() * 500; 

        timeoutGeneracionArboles = setTimeout(() => {
            if (juegoActivo) {
                generarArbol();
                iniciarGeneracionArboles(); 
            }
        }, tiempoEspera);
    }

    function actualizarPuntuacion() {
        if (juegoActivo) {
            puntuacion++;
            puntuacionDisplay.textContent = 'Puntos: ' + puntuacion;

            if (velocidadArbol < MAX_VELOCIDAD) {
                velocidadArbol += ACELERACION;
            }
        }
    }

    function finJuego() {
        sonidoGameOver.currentTime = 0;
        // Manejo de promesa para evitar errores de reproducci贸n
        const playPromise = sonidoGameOver.play(); 
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // console.log("Fallo al reproducir sonido de gameover: ", error);
            });
        }
        
        clearInterval(intervaloPuntuacion);
        clearTimeout(timeoutGeneracionArboles); 

        if (puntuacion > mejorPuntuacion) {
            mejorPuntuacion = puntuacion;
            localStorage.setItem('mejorPuntuacion', mejorPuntuacion);
        }

        mensajeFin.classList.remove('oculto');
        document.getElementById('puntuacion-final').textContent = 'Puntuaci贸n final: ' + puntuacion;
        document.getElementById('mejor-final').textContent = 'Mejor puntuaci贸n: ' + mejorPuntuacion;
        mejorDisplay.textContent = 'Mejor: ' + mejorPuntuacion;
    }

    function reiniciarJuego() {
        juegoActivo = true;
        estaSaltando = false;
        puntuacion = 0;
        velocidadArbol = 2.5; 
        caballo.style.bottom = '0px';
        puntuacionDisplay.textContent = 'Puntos: 0';
        mensajeFin.classList.add('oculto');

        document.querySelectorAll('.arbol').forEach(a => a.remove());

        iniciarJuego();
    }

    function iniciarJuego() {
        intervaloPuntuacion = setInterval(actualizarPuntuacion, 100); 
        iniciarGeneracionArboles(); 
    }

    iniciarJuego();
</script>
</body>
</html>
